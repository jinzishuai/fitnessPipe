name: Maestro iOS Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: maestro-${{ github.ref }}
  cancel-in-progress: true

jobs:
  maestro-test:
    if: github.repository == 'jinzishuai/fitnessPipe'
    runs-on: [self-hosted, mac-mini]

    env:
      # iPhone 16 Rosetta (Created manually on the self-hosted machine)
      # UUID: 0DF6EEDE-9FD6-40F7-8CA2-F8416D987E30
      # SIMULATOR_ID: "0DF6EEDE-9FD6-40F7-8CA2-F8416D987E30" # iPhone 16
      SIMULATOR_ID: "AB7CA7A8-6217-4CE9-995B-3E4B72C343C1" # iPhone 17

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Verify Environment
        run: |
          echo "Checking for Flutter..."
          which flutter
          flutter --version
          
          echo "Checking for Maestro..."
          which maestro
          maestro --version

      - name: Boot Simulator
        run: |
          # Boot the specific persistent simulator using our script
          # We set BOOT_ONLY=true so the script doesn't try to 'flutter run'
          export SIMULATOR_ID=${{ env.SIMULATOR_ID }}
          export BOOT_ONLY=true
          chmod +x run_rosetta.sh
          ./run_rosetta.sh

      - name: Build Application
        run: |
          flutter pub get
          flutter build ios --simulator --no-codesign --debug

      - name: Install App on Simulator
        run: |
          APP_PATH="build/ios/iphonesimulator/Runner.app"
          
          echo "Installing $APP_PATH to ${{ env.SIMULATOR_ID }}"
          # Uninstall app and Maestro driver to ensure clean state
          xcrun simctl uninstall "${{ env.SIMULATOR_ID }}" "com.fitnesspipe.fitnessPipe" || true
          xcrun simctl uninstall "${{ env.SIMULATOR_ID }}" "dev.mobile.maestro-driver-ios" || true
          xcrun simctl uninstall "${{ env.SIMULATOR_ID }}" "dev.mobile.maestro-driver-ios.xctrunner" || true
          
          xcrun simctl install "${{ env.SIMULATOR_ID }}" "$APP_PATH"
          
          # Wait for app installation to fully complete
          echo "Waiting for app to settle..."
          sleep 10

      - name: Run Maestro Tests
        run: |
          chmod +x maestro-test/run_ios_headless.sh
          ./maestro-test/run_ios_headless.sh

      - name: Collect Screenshots
        if: always()
        run: |
          mkdir -p maestro-screenshots
          COUNT=0

          # 1) Collect takeScreenshot outputs from project root
          for img in *.png *.jpg *.jpeg; do
            [ -f "$img" ] || continue
            COUNT=$((COUNT + 1))
            cp "$img" "maestro-screenshots/${img}"
          done

          # 2) Collect failure screenshots from --debug-output folder
          while IFS= read -r img; do
            COUNT=$((COUNT + 1))
            BASENAME=$(basename "$img")
            DEST="debug-${COUNT}-${BASENAME}"
            cp "$img" "maestro-screenshots/${DEST}"
          done < <(find maestro-report/debug -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) 2>/dev/null | sort)
          
          echo "SCREENSHOT_COUNT=${COUNT}" >> "$GITHUB_ENV"

      - name: Publish Screenshots to Branch
        if: always() && env.SCREENSHOT_COUNT != '0'
        run: |
          # Configure git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # Create a temporary work directory for the screenshots branch
          mkdir -p ../screenshots-repo
          
          # Clone/Checkout the screenshots branch
          # We use the GITHUB_TOKEN to auth
          git clone --depth 1 --branch screenshots https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ../screenshots-repo 2>/dev/null || \
          git clone --depth 1 https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ../screenshots-repo

          cd ../screenshots-repo
          
          # If screenshots branch doesn't exist remotely (failed first clone), create it orphan
          if ! git show-ref --verify --quiet refs/remotes/origin/screenshots; then
            git checkout --orphan screenshots
            git rm -rf .
          else
            git checkout screenshots
          fi

          # Copy screenshots to a folder specific to this run
          DEST_DIR="runs/${{ github.run_id }}"
          mkdir -p "$DEST_DIR"
          cp -R ../fitnessPipe/maestro-screenshots/* "$DEST_DIR/"

          # Push changes
          git add .
          git commit -m "Add screenshots for run ${{ github.run_id }}"
          git push origin screenshots

      - name: Generate Screenshot Summary
        if: always()
        run: |
          echo "## ðŸ“¸ Maestro Test Screenshots" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ env.SCREENSHOT_COUNT }}" -eq "0" ]; then
            echo "No screenshots were captured during this test run." >> "$GITHUB_STEP_SUMMARY"
          else
            # Use the raw GitHub URL which works for private repos if the user is logged in
            BASE_URL="https://github.com/${{ github.repository }}/raw/screenshots/runs/${{ github.run_id }}"
            
            for img in maestro-screenshots/*; do
              NAME=$(basename "$img")
              IMG_URL="${BASE_URL}/${NAME}"
              
              echo "<details open><summary><strong>${NAME}</strong></summary>" >> "$GITHUB_STEP_SUMMARY"
              echo "<br/>" >> "$GITHUB_STEP_SUMMARY"
              echo "<a href=\"${IMG_URL}\"><img src=\"${IMG_URL}\" width=\"400\" /></a>" >> "$GITHUB_STEP_SUMMARY"
              echo "<br/>" >> "$GITHUB_STEP_SUMMARY"
              echo "</details>" >> "$GITHUB_STEP_SUMMARY"
              echo "<br/>" >> "$GITHUB_STEP_SUMMARY"
            done
            
            echo "**Total: ${{ env.SCREENSHOT_COUNT }} screenshot(s)**" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: maestro-screenshots/
          if-no-files-found: ignore

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-report
          path: maestro-report/
