name: Maestro iOS Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: maestro-${{ github.ref }}
  cancel-in-progress: true

jobs:
  maestro-test:
    if: github.repository == 'jinzishuai/fitnessPipe'
    runs-on: [self-hosted, mac-mini]

    env:
      # iPhone 16 Rosetta (Created manually on the self-hosted machine)
      # UUID: 0DF6EEDE-9FD6-40F7-8CA2-F8416D987E30
      # SIMULATOR_ID: "0DF6EEDE-9FD6-40F7-8CA2-F8416D987E30" # iPhone 16
      SIMULATOR_ID: "AB7CA7A8-6217-4CE9-995B-3E4B72C343C1" # iPhone 17

    steps:
      - uses: actions/checkout@v4

      - name: Verify Environment
        run: |
          echo "Checking for Flutter..."
          which flutter
          flutter --version
          
          echo "Checking for Maestro..."
          which maestro
          maestro --version

      - name: Boot Simulator
        run: |
          # Boot the specific persistent simulator using our script
          # We set BOOT_ONLY=true so the script doesn't try to 'flutter run'
          export SIMULATOR_ID=${{ env.SIMULATOR_ID }}
          export BOOT_ONLY=true
          chmod +x run_rosetta.sh
          ./run_rosetta.sh

      - name: Build Application
        run: |
          flutter pub get
          flutter build ios --simulator --no-codesign --debug

      - name: Install App on Simulator
        run: |
          APP_PATH="build/ios/iphonesimulator/Runner.app"
          
          echo "Installing $APP_PATH to ${{ env.SIMULATOR_ID }}"
          # Uninstall app and Maestro driver to ensure clean state
          xcrun simctl uninstall "${{ env.SIMULATOR_ID }}" "com.fitnesspipe.fitnessPipe" || true
          xcrun simctl uninstall "${{ env.SIMULATOR_ID }}" "dev.mobile.maestro-driver-ios" || true
          xcrun simctl uninstall "${{ env.SIMULATOR_ID }}" "dev.mobile.maestro-driver-ios.xctrunner" || true
          
          xcrun simctl install "${{ env.SIMULATOR_ID }}" "$APP_PATH"
          
          # Wait for app installation to fully complete
          echo "Waiting for app to settle..."
          sleep 10

      - name: Run Maestro Tests
        run: |
          chmod +x maestro-test/run_ios_headless.sh
          ./maestro-test/run_ios_headless.sh

      - name: Collect Screenshots
        if: always()
        run: |
          mkdir -p maestro-screenshots
          COUNT=0

          # 1) Collect takeScreenshot outputs from project root
          for img in *.png *.jpg *.jpeg; do
            [ -f "$img" ] || continue
            COUNT=$((COUNT + 1))
            cp "$img" "maestro-screenshots/${img}"
          done

          # 2) Collect failure screenshots from --debug-output folder
          while IFS= read -r img; do
            COUNT=$((COUNT + 1))
            BASENAME=$(basename "$img")
            DEST="debug-${COUNT}-${BASENAME}"
            cp "$img" "maestro-screenshots/${DEST}"
          done < <(find maestro-report/debug -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) 2>/dev/null | sort)
          
          echo "SCREENSHOT_COUNT=${COUNT}" >> "$GITHUB_ENV"

      - name: Generate Screenshot Summary
        if: always()
        run: |
          echo "## ðŸ“¸ Maestro Test Screenshots" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ env.SCREENSHOT_COUNT }}" -eq "0" ]; then
            echo "No screenshots were captured during this test run." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| # | Screenshot | Size |" >> "$GITHUB_STEP_SUMMARY"
            echo "|---|------------|------|" >> "$GITHUB_STEP_SUMMARY"
            
            i=0
            for img in maestro-screenshots/*; do
              i=$((i + 1))
              NAME=$(basename "$img")
              SIZE=$(du -h "$img" | cut -f1)
              echo "| ${i} | \`${NAME}\` | ${SIZE} |" >> "$GITHUB_STEP_SUMMARY"
            done
            
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Total: ${{ env.SCREENSHOT_COUNT }} screenshot(s)**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> ðŸ’¡ Download the **maestro-screenshots** artifact below to view these images." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-screenshots
          path: maestro-screenshots/
          if-no-files-found: ignore
          retention-days: 5

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-report
          path: maestro-report/
          retention-days: 5
